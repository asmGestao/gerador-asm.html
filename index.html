<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéõÔ∏è GERADOR ASM - Criar Acesso Exclusivo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: #264653;
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .content {
            padding: 40px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #264653;
            font-size: 16px;
        }
        
        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #2a9d8f;
            box-shadow: 0 0 0 3px rgba(42, 157, 143, 0.1);
        }
        
        .btn-generate {
            width: 100%;
            padding: 20px;
            background: #2a9d8f;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-generate:hover {
            background: #21867a;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(42, 157, 143, 0.3);
        }
        
        .result {
            display: none;
            margin-top: 30px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 5px solid #2a9d8f;
        }
        
        .result.show {
            display: block;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .credentials {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #e0e0e0;
        }
        
        .credentials h3 {
            color: #264653;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .cred-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .cred-item:last-child {
            border-bottom: none;
        }
        
        .cred-label {
            font-weight: bold;
            color: #666;
        }
        
        .cred-value {
            color: #2a9d8f;
            font-weight: bold;
            font-family: monospace;
            font-size: 16px;
        }
        
        .instructions {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #ffc107;
        }
        
        .instructions h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .instructions ol {
            margin-left: 20px;
            color: #856404;
            line-height: 1.8;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            color: #666;
            font-size: 14px;
        }
        
        .logo-asm {
            font-size: 48px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-asm">üéõÔ∏è</div>
            <h1>GERADOR ASM</h1>
            <p>Crie c√≥digos personalizados para seus profissionais</p>
        </div>
        
        <div class="content">
            <div class="form-group">
                <label>üë§ Nome do Profissional</label>
                <input type="text" id="profName" placeholder="Ex: Dra. Maria Silva">
            </div>
            
            <div class="form-group">
                <label>üîë Usu√°rio (Login)</label>
                <input type="text" id="profUser" placeholder="Ex: maria2024">
            </div>
            
            <div class="form-group">
                <label>üîí Senha</label>
                <input type="text" id="profPass" placeholder="Ex: Maria@2024">
            </div>
            
            <button class="btn-generate" onclick="generateCode()">
                ‚ö° GERAR C√ìDIGO PERSONALIZADO
            </button>
            
            <div id="resultArea" class="result">
                <h2 style="color: #264653; margin-bottom: 20px;">‚úÖ C√≥digo Gerado com Sucesso!</h2>
                
                <div class="credentials">
                    <h3>üìã Credenciais de Acesso</h3>
                    <div class="cred-item">
                        <span class="cred-label">Profissional:</span>
                        <span class="cred-value" id="resName"></span>
                    </div>
                    <div class="cred-item">
                        <span class="cred-label">Usu√°rio:</span>
                        <span class="cred-value" id="resUser"></span>
                    </div>
                    <div class="cred-item">
                        <span class="cred-label">Senha:</span>
                        <span class="cred-value" id="resPass"></span>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn-generate" onclick="downloadFile()" style="background: #264653;">
                        üì• BAIXAR ARQUIVO HTML PRONTO
                    </button>
                </div>
                
                <div class="instructions">
                    <h4>üì§ Como enviar para o profissional:</h4>
                    <ol>
                        <li>Clique no bot√£o acima para baixar o arquivo</li>
                        <li>O arquivo ter√° o nome: <strong>ASM_[nome_do_profissional].html</strong></li>
                        <li>Envie este arquivo via WhatsApp, e-mail ou Telegram</li>
                        <li>O profissional abre no navegador e usa as credenciais acima</li>
                        <li>Pronto! Ele ter√° acesso apenas aos dados dele</li>
                    </ol>
                </div>
                
                <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #28a745;">
                    <strong>üí° Dica:</strong> Guarde as credenciais em um arquivo separado. O profissional pode trocar a senha depois nas configura√ß√µes do sistema.
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p><strong>ASM Gest√£o Cl√≠nica</strong> - Sistema Exclusivo por Dra. Andresa Augusto</p>
            <p>¬© 2024 - Todos os direitos reservados</p>
        </div>
    </div>

    <script>
        let generatedCode = '';
        
        function generateCode() {
            const name = document.getElementById('profName').value.trim();
            const user = document.getElementById('profUser').value.trim().toLowerCase();
            const pass = document.getElementById('profPass').value.trim();
            
            if (!name || !user || !pass) {
                alert('Preencha todos os campos!');
                return;
            }
            
            if (pass.length < 6) {
                alert('A senha deve ter no m√≠nimo 6 caracteres!');
                return;
            }
            
            // Gerar o c√≥digo completo do sistema com login √∫nico embutido
            generatedCode = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASM Gest√£o Cl√≠nica - ${name}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: #f0f2f5;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #264653 0%, #2a9d8f 100%);
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        
        .login-box h1 {
            color: #264653;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .login-box h2 {
            color: #666;
            font-size: 18px;
            margin-bottom: 30px;
            font-weight: normal;
        }
        
        .login-box .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .login-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .login-box input:focus {
            outline: none;
            border-color: #2a9d8f;
        }
        
        .login-btn {
            width: 100%;
            padding: 14px;
            background: #2a9d8f;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .login-btn:hover {
            background: #21867a;
        }
        
        .login-error {
            color: #e76f51;
            margin-top: 15px;
            display: none;
        }
        
        .header {
            background: #264653;
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .header p { font-size: 14px; opacity: 0.9; }
        
        .user-bar {
            background: #1a3a47;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        
        .user-bar button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background: #2a9d8f;
            flex-wrap: wrap;
        }
        
        .nav button {
            padding: 10px 20px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .nav button:hover, .nav button.active {
            background: white;
            color: #264653;
        }
        
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .section {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section.active { display: block; }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        .btn-primary { background: #2a9d8f; color: white; }
        .btn-success { background: #52b788; color: white; }
        .btn-danger { background: #e76f51; color: white; }
        .btn-whatsapp { background: #25d366; color: white; }
        .btn-warning { background: #f4a261; color: white; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .card:hover {
            border-color: #2a9d8f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 20px;
        }
        
        .calendar-header {
            text-align: center;
            font-weight: bold;
            padding: 10px;
            background: #264653;
            color: white;
        }
        
        .calendar-day {
            background: #f8f9fa;
            min-height: 100px;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .calendar-day:hover { background: #e9ecef; }
        
        .appointment {
            background: #2a9d8f;
            color: white;
            padding: 5px;
            margin: 2px 0;
            border-radius: 3px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .appointment.cancelled {
            background: #adb5bd;
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        .appointment-actions {
            display: flex;
            gap: 3px;
        }
        
        .appointment-actions button {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-btn {
            font-size: 24px;
            cursor: pointer;
            background: none;
            border: none;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th { background: #f8f9fa; font-weight: bold; }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            color: white;
        }
        
        .summary-card.green { background: #52b788; }
        .summary-card.red { background: #e76f51; }
        .summary-card.blue { background: #264653; }
        
        .summary-card h3 { font-size: 32px; margin-bottom: 5px; }
        .summary-card p { font-size: 14px; opacity: 0.9; }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }
        
        .tab.active {
            color: #2a9d8f;
            border-bottom: 2px solid #2a9d8f;
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .report-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: monospace;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .settings-box {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #264653;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            background: #264653;
            color: white;
            margin-top: 40px;
            font-size: 12px;
        }
        
        .footer p { margin: 5px 0; opacity: 0.8; }
    </style>
</head>
<body>
    <!-- TELA DE LOGIN -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1>üè• ASM Gest√£o Cl√≠nica</h1>
            <h2>Acesso Exclusivo<br><strong>${name}</strong></h2>
            
            <div class="form-group">
                <label>Usu√°rio</label>
                <input type="text" id="loginUser" placeholder="Digite seu usu√°rio">
            </div>
            
            <div class="form-group">
                <label>Senha</label>
                <input type="password" id="loginPass" placeholder="Digite sua senha">
            </div>
            
            <button class="login-btn" onclick="doLogin()">Entrar</button>
            <div id="loginError" class="login-error">Usu√°rio ou senha incorretos!</div>
        </div>
    </div>

    <!-- SISTEMA PRINCIPAL -->
    <div id="mainSystem" style="display: none;">
        <div class="header">
            <h1>üè• ASM Gest√£o Cl√≠nica</h1>
            <p id="headerSubtitle">Sistema de Gest√£o para Fisioterapeutas</p>
        </div>
        
        <div class="user-bar">
            <div>üë§ <span id="currentUserName">${name}</span></div>
            <div>
                <button onclick="logout()">üö™ Sair</button>
            </div>
        </div>
        
        <div class="nav">
            <button class="active" onclick="showSection('agenda')">üìÖ Agenda</button>
            <button onclick="showSection('pacientes')">üë• Pacientes</button>
            <button onclick="showSection('financeiro')">üí∞ Financeiro</button>
            <button onclick="showSection('fluxo')">üìä Fluxo de Caixa</button>
            <button onclick="showSection('relatorios')">üìà Relat√≥rios</button>
            <button onclick="showSection('configuracoes')">‚öôÔ∏è Configura√ß√µes</button>
        </div>
        
        <div class="container">
            <!-- CONFIGURA√á√ïES -->
            <div id="configuracoes" class="section">
                <h2>‚öôÔ∏è Configura√ß√µes do Sistema</h2>
                <p style="margin-bottom: 20px; color: #666;">Configure aqui os dados do profissional que aparecer√£o nos relat√≥rios e mensagens.</p>
                
                <div class="settings-box">
                    <div class="form-group">
                        <label>Nome do Profissional *</label>
                        <input type="text" id="configName" placeholder="Ex: ${name}">
                    </div>
                    
                    <div class="form-group">
                        <label>N√∫mero do CREFITO *</label>
                        <input type="text" id="configCrefito" placeholder="Ex: 123456-F">
                    </div>
                    
                    <div class="form-group">
                        <label>Nome da Cl√≠nica (opcional)</label>
                        <input type="text" id="configClinic" placeholder="Ex: ASM Fisioterapia">
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveConfig()">üíæ Salvar Configura√ß√µes</button>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <strong>‚ÑπÔ∏è Importante:</strong> Estas informa√ß√µes ser√£o usadas automaticamente nas mensagens do WhatsApp e nos relat√≥rios gerados pelo sistema.
                </div>
            </div>
            
            <!-- AGENDA -->
            <div id="agenda" class="section active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Agenda de Atendimentos</h2>
                    <button class="btn btn-primary" onclick="openAppointmentModal()">+ Novo Agendamento</button>
                </div>
                
                <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="changeMonth(-1)">‚Üê Anterior</button>
                    <h3 id="currentMonth"></h3>
                    <button class="btn btn-primary" onclick="changeMonth(1)">Pr√≥ximo ‚Üí</button>
                </div>
                
                <div class="calendar" id="calendar"></div>
            </div>
            
            <!-- PACIENTES -->
            <div id="pacientes" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Cadastro de Pacientes</h2>
                    <button class="btn btn-primary" onclick="openPatientModal()">+ Novo Paciente</button>
                </div>
                
                <input type="text" style="width: 100%; padding: 10px; margin-bottom: 20px;" placeholder="Buscar paciente..." oninput="searchPatients(this.value)">
                
                <div class="grid" id="patientsList"></div>
            </div>
            
            <!-- FINANCEIRO -->
            <div id="financeiro" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Controle Financeiro</h2>
                    <button class="btn btn-success" onclick="exportToExcel()">üìä Exportar Excel</button>
                </div>
                
                <div class="summary-cards">
                    <div class="summary-card green">
                        <h3 id="totalReceived">R$ 0,00</h3>
                        <p>Total Recebido</p>
                    </div>
                    <div class="summary-card red">
                        <h3 id="totalPending">R$ 0,00</h3>
                        <p>Total a Receber</p>
                    </div>
                    <div class="summary-card blue">
                        <h3 id="totalSessions">0</h3>
                        <p>Total de Sess√µes</p>
                    </div>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Paciente</th>
                            <th>Data</th>
                            <th>Servi√ßo</th>
                            <th>Valor</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="financialTable"></tbody>
                </table>
            </div>
            
            <!-- FLUXO DE CAIXA -->
            <div id="fluxo" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Fluxo de Caixa</h2>
                    <button class="btn btn-primary" onclick="openExpenseModal()">+ Nova Despesa</button>
                </div>
                
                <div class="form-group">
                    <label>M√™s/Ano</label>
                    <input type="month" id="cashFlowMonth" onchange="renderCashFlow()">
                </div>
                
                <div class="summary-cards">
                    <div class="summary-card green">
                        <h3 id="cfEntries">R$ 0,00</h3>
                        <p>Entradas</p>
                    </div>
                    <div class="summary-card red">
                        <h3 id="cfExits">R$ 0,00</h3>
                        <p>Sa√≠das</p>
                    </div>
                    <div class="summary-card blue">
                        <h3 id="cfBalance">R$ 0,00</h3>
                        <p>Saldo</p>
                    </div>
                </div>
                
                <div class="tabs">
                    <button class="tab active" onclick="showCashFlowTab('entries')">Entradas</button>
                    <button class="tab" onclick="showCashFlowTab('exits')">Despesas</button>
                </div>
                
                <div id="cfEntriesTab" class="tab-content active">
                    <table>
                        <thead>
                            <tr><th>Data</th><th>Paciente</th><th>Servi√ßo</th><th>Valor</th></tr>
                        </thead>
                        <tbody id="entriesTable"></tbody>
                    </table>
                </div>
                
                <div id="cfExitsTab" class="tab-content">
                    <table>
                        <thead>
                            <tr><th>Data</th><th>Descri√ß√£o</th><th>Categoria</th><th>Valor</th><th>A√ß√µes</th></tr>
                        </thead>
                        <tbody id="exitsTable"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- RELAT√ìRIOS -->
            <div id="relatorios" class="section">
                <h2>Relat√≥rios de Gest√£o</h2>
                
                <div class="form-group">
                    <label>M√™s/Ano</label>
                    <input type="month" id="reportMonth" onchange="renderReports()">
                </div>
                
                <div class="summary-cards">
                    <div class="summary-card blue">
                        <h3 id="reportSessions">0</h3>
                        <p>Atendimentos</p>
                    </div>
                    <div class="summary-card green">
                        <h3 id="reportRevenue">R$ 0,00</h3>
                        <p>Faturamento</p>
                    </div>
                </div>
                
                <h3 style="margin-top: 30px;">Pacientes Atendidos</h3>
                <table>
                    <thead>
                        <tr><th>Paciente</th><th>Sess√µes</th><th>Total</th></tr>
                    </thead>
                    <tbody id="reportTable"></tbody>
                </table>
            </div>
        </div>
        
        <!-- MODAIS (simplificados para o exemplo) -->
        <div class="modal" id="appointmentModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Agendamento</h3>
                    <button class="close-btn" onclick="closeModal('appointmentModal')">&times;</button>
                </div>
                <div class="form-group">
                    <label>Paciente *</label>
                    <select id="apptPatient"></select>
                </div>
                <div class="form-group">
                    <label>Data *</label>
                    <input type="date" id="apptDate">
                </div>
                <div class="form-group">
                    <label>Hor√°rio *</label>
                    <input type="time" id="apptTime">
                </div>
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="apptType">
                        <option value="normal">Normal</option>
                        <option value="laser">Com Laser</option>
                        <option value="avaliacao">Avalia√ß√£o</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Valor (R$)</label>
                    <input type="number" id="apptValue" step="0.01">
                </div>
                <button class="btn btn-primary" onclick="saveAppointment()">Salvar</button>
            </div>
        </div>
        
        <div class="modal" id="patientModal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h3 id="patientModalTitle">Novo Paciente</h3>
                    <button class="close-btn" onclick="closeModal('patientModal')">&times;</button>
                </div>
                <div class="tabs">
                    <button class="tab active" onclick="showPatientTab('info')">Informa√ß√µes</button>
                    <button class="tab" onclick="showPatientTab('financeiro')">Financeiro</button>
                    <button class="tab" onclick="showPatientTab('evolucao')">Evolu√ß√£o</button>
                </div>
                <div id="tabInfo" class="tab-content active">
                    <input type="hidden" id="patientId">
                    <div class="form-group">
                        <label>Nome Completo *</label>
                        <input type="text" id="patientName">
                    </div>
                    <div class="form-group">
                        <label>Telefone *</label>
                        <input type="tel" id="patientPhone" placeholder="(00) 00000-0000">
                    </div>
                    <div class="form-group">
                        <label>E-mail</label>
                        <input type="email" id="patientEmail">
                    </div>
                    <div class="form-group">
                        <label>Valor Padr√£o (R$)</label>
                        <input type="number" id="patientValue" step="0.01">
                    </div>
                </div>
                <div id="tabFinanceiro" class="tab-content">
                    <div class="summary-cards">
                        <div class="summary-card green">
                            <h3 id="patientPaid">R$ 0,00</h3>
                            <p>Pago</p>
                        </div>
                        <div class="summary-card red">
                            <h3 id="patientPending">R$ 0,00</h3>
                            <p>Pendente</p>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr><th>Data</th><th>Servi√ßo</th><th>Valor</th><th>Status</th></tr>
                        </thead>
                        <tbody id="patientFinanceTable"></tbody>
                    </table>
                </div>
                <div id="tabEvolucao" class="tab-content">
                    <div class="form-group">
                        <label>Nova Evolu√ß√£o</label>
                        <textarea id="newEvolution" rows="4" placeholder="Descreva a evolu√ß√£o..."></textarea>
                        <button class="btn btn-primary" onclick="addEvolution()" style="margin-top: 10px;">Salvar Evolu√ß√£o</button>
                    </div>
                    <div id="evolutionsList"></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button class="btn btn-danger" id="btnDeletePatient" onclick="deletePatient()">Excluir</button>
                    <button class="btn btn-primary" onclick="savePatient()">Salvar Paciente</button>
                </div>
            </div>
        </div>
        
        <div class="modal" id="expenseModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Nova Despesa</h3>
                    <button class="close-btn" onclick="closeModal('expenseModal')">&times;</button>
                </div>
                <div class="form-group">
                    <label>Data *</label>
                    <input type="date" id="expenseDate">
                </div>
                <div class="form-group">
                    <label>Descri√ß√£o *</label>
                    <input type="text" id="expenseDesc" placeholder="Ex: Aluguel, Material...">
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="expenseCategory">
                        <option value="material">Material/Equipamento</option>
                        <option value="aluguel">Aluguel</option>
                        <option value="servicos">Servi√ßos</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Valor (R$) *</label>
                    <input type="number" id="expenseValue" step="0.01">
                </div>
                <button class="btn btn-primary" onclick="saveExpense()">Salvar Despesa</button>
            </div>
        </div>

        <div class="footer">
            <p><strong>ASM Gest√£o Cl√≠nica</strong></p>
            <p>¬© 2024 Dra. Andresa Augusto - Todos os direitos reservados</p>
            <p>Proibida a reprodu√ß√£o total ou parcial sem autoriza√ß√£o expressa</p>
            <p>Desenvolvido exclusivamente para uso profissional autorizado</p>
        </div>
    </div>

    <script>
        // CREDENCIAIS FIXAS (embbeded)
        const VALID_USER = '${user}';
        const VALID_PASS = '${pass}';
        const USER_NAME = '${name}';
        
        // DADOS DO USU√ÅRIO
        let config = JSON.parse(localStorage.getItem('asm_config')) || {
            professionalName: USER_NAME,
            crefito: '',
            clinicName: 'ASM Fisioterapia'
        };
        
        let patients = JSON.parse(localStorage.getItem('asm_patients')) || [];
        let appointments = JSON.parse(localStorage.getItem('asm_appointments')) || [];
        let evolutions = JSON.parse(localStorage.getItem('asm_evolutions')) || [];
        let expenses = JSON.parse(localStorage.getItem('asm_expenses')) || [];
        
        let currentDate = new Date();
        let currentPatientId = null;
        let currentApptId = null;

        // LOGIN
        function doLogin() {
            const u = document.getElementById('loginUser').value.trim().toLowerCase();
            const p = document.getElementById('loginPass').value;
            
            if (u === VALID_USER && p === VALID_PASS) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainSystem').style.display = 'block';
                initializeApp();
            } else {
                document.getElementById('loginError').style.display = 'block';
                setTimeout(() => document.getElementById('loginError').style.display = 'none', 3000);
            }
        }
        
        function logout() {
            location.reload();
        }
        
        function initializeApp() {
            loadConfig();
            renderCalendar();
            renderPatients();
            updateFinancialSummary();
            loadPatientSelect();
            
            const today = new Date().toISOString().slice(0, 7);
            document.getElementById('cashFlowMonth').value = today;
            document.getElementById('reportMonth').value = today;
        }

        function loadConfig() {
            document.getElementById('configName').value = config.professionalName;
            document.getElementById('configCrefito').value = config.crefito;
            document.getElementById('configClinic').value = config.clinicName;
            updateHeader();
        }
        
        function saveConfig() {
            config.professionalName = document.getElementById('configName').value.trim();
            config.crefito = document.getElementById('configCrefito').value.trim();
            config.clinicName = document.getElementById('configClinic').value.trim() || 'ASM Fisioterapia';
            
            if (!config.professionalName || !config.crefito) {
                alert('Preencha o nome do profissional e o CREFITO!');
                return;
            }
            
            localStorage.setItem('asm_config', JSON.stringify(config));
            updateHeader();
            alert('Configura√ß√µes salvas com sucesso!');
        }
        
        function updateHeader() {
            const subtitle = document.getElementById('headerSubtitle');
            if (config.professionalName) {
                subtitle.textContent = config.professionalName + ' - CREFITO ' + config.crefito;
            } else {
                subtitle.textContent = 'Configure seus dados em "Configura√ß√µes"';
            }
        }
        
        function getProfessionalSignature() {
            const name = config.professionalName || 'Profissional';
            const crefito = config.crefito ? 'CREFITO ' + config.crefito : '';
            const clinic = config.clinicName || 'ASM Fisioterapia';
            return { name, crefito, clinic };
        }

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            
            document.getElementById(section).classList.add('active');
            event.target.classList.add('active');
            
            if (section === 'financeiro') renderFinancialTable();
            if (section === 'fluxo') renderCashFlow();
            if (section === 'relatorios') renderReports();
        }

        // CALEND√ÅRIO
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonth').textContent = 
                new Date(year, month).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';
            
            const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            days.forEach(day => {
                const div = document.createElement('div');
                div.className = 'calendar-header';
                div.textContent = day;
                calendar.appendChild(div);
            });
            
            for (let i = 0; i < firstDay; i++) {
                calendar.appendChild(document.createElement('div'));
            }
            
            const today = new Date();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const div = document.createElement('div');
                div.className = 'calendar-day';
                div.innerHTML = '<strong>' + day + '</strong>';
                
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    div.style.background = '#2a9d8f';
                    div.style.color = 'white';
                }
                
                const dayAppointments = appointments.filter(a => {
                    const parts = a.date.split('-');
                    const y = parseInt(parts[0]);
                    const m = parseInt(parts[1]);
                    const d = parseInt(parts[2]);
                    return y === year && (m - 1) === month && d === day;
                });
                
                dayAppointments.forEach(appt => {
                    const patient = patients.find(p => p.id === appt.patientId);
                    const apptDiv = document.createElement('div');
                    apptDiv.className = 'appointment' + (appt.cancelled ? ' cancelled' : '');
                    apptDiv.innerHTML = '<span>' + appt.time + ' ' + (patient ? patient.name.split(' ')[0] : '') + '</span>';
                    
                    const actions = document.createElement('div');
                    actions.className = 'appointment-actions';
                    
                    const editBtn = document.createElement('button');
                    editBtn.textContent = '‚úé';
                    editBtn.onclick = function(e) {
                        e.stopPropagation();
                        editAppointment(appt.id);
                    };
                    
                    const cancelBtn = document.createElement('button');
                    cancelBtn.textContent = appt.cancelled ? '‚Ü©' : '‚úï';
                    cancelBtn.onclick = function(e) {
                        e.stopPropagation();
                        toggleCancelAppointmentDirect(appt.id);
                    };
                    
                    actions.appendChild(editBtn);
                    actions.appendChild(cancelBtn);
                    apptDiv.appendChild(actions);
                    
                    div.appendChild(apptDiv);
                });
                
                div.onclick = function() {
                    openAppointmentModal(year, month, day);
                };
                calendar.appendChild(div);
            }
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }

        // PACIENTES
        function renderPatients() {
            const list = document.getElementById('patientsList');
            list.innerHTML = '';
            
            patients.forEach(p => {
                const patientAppts = appointments.filter(a => a.patientId === p.id && !a.cancelled);
                const pending = patientAppts.filter(a => !a.paid).length;
                
                const card = document.createElement('div');
                card.className = 'card';
                let html = '<h3>' + p.name + '</h3>';
                html += '<p>üì± ' + p.phone + '</p>';
                html += '<p>üí∞ R$ ' + parseFloat(p.defaultValue || 0).toFixed(2) + '</p>';
                if (pending > 0) {
                    html += '<p style="color: #e76f51;">‚ö†Ô∏è ' + pending + ' pendente(s)</p>';
                }
                card.innerHTML = html;
                card.onclick = function() {
                    openPatientModal(p.id);
                };
                list.appendChild(card);
            });
        }

        function searchPatients(term) {
            const cards = document.querySelectorAll('#patientsList .card');
            cards.forEach(card => {
                const name = card.querySelector('h3').textContent.toLowerCase();
                card.style.display = name.includes(term.toLowerCase()) ? 'block' : 'none';
            });
        }

        function openPatientModal(patientId) {
            currentPatientId = patientId;
            const modal = document.getElementById('patientModal');
            
            document.getElementById('patientId').value = '';
            document.getElementById('patientName').value = '';
            document.getElementById('patientPhone').value = '';
            document.getElementById('patientEmail').value = '';
            document.getElementById('patientValue').value = '';
            
            showPatientTab('info');
            
            if (patientId) {
                const p = patients.find(x => x.id === patientId);
                document.getElementById('patientModalTitle').textContent = 'Editar Paciente';
                document.getElementById('patientId').value = p.id;
                document.getElementById('patientName').value = p.name;
                document.getElementById('patientPhone').value = p.phone;
                document.getElementById('patientEmail').value = p.email || '';
                document.getElementById('patientValue').value = p.defaultValue || '';
                document.getElementById('btnDeletePatient').style.display = 'block';
                
                renderPatientFinance();
                renderEvolutions();
            } else {
                document.getElementById('patientModalTitle').textContent = 'Novo Paciente';
                document.getElementById('btnDeletePatient').style.display = 'none';
            }
            
            modal.classList.add('active');
        }

        function savePatient() {
            const id = document.getElementById('patientId').value;
            const data = {
                id: id || Date.now().toString(),
                name: document.getElementById('patientName').value,
                phone: document.getElementById('patientPhone').value,
                email: document.getElementById('patientEmail').value,
                defaultValue: document.getElementById('patientValue').value
            };
            
            if (!data.name || !data.phone) {
                alert('Preencha nome e telefone!');
                return;
            }
            
            if (id) {
                const idx = patients.findIndex(p => p.id === id);
                patients[idx] = data;
            } else {
                patients.push(data);
            }
            
            localStorage.setItem('asm_patients', JSON.stringify(patients));
            closeModal('patientModal');
            renderPatients();
            loadPatientSelect();
        }

        function deletePatient() {
            if (!confirm('Excluir paciente e todos os dados?')) return;
            
            patients = patients.filter(p => p.id !== currentPatientId);
            appointments = appointments.filter(a => a.patientId !== currentPatientId);
            evolutions = evolutions.filter(e => e.patientId !== currentPatientId);
            
            localStorage.setItem('asm_patients', JSON.stringify(patients));
            localStorage.setItem('asm_appointments', JSON.stringify(appointments));
            localStorage.setItem('asm_evolutions', JSON.stringify(evolutions));
            
            closeModal('patientModal');
            renderPatients();
            renderCalendar();
            updateFinancialSummary();
        }

        function showPatientTab(tab) {
            document.querySelectorAll('#patientModal .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#patientModal .tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            
            if (tab === 'financeiro') renderPatientFinance();
            if (tab === 'evolucao') renderEvolutions();
        }

        // AGENDAMENTOS
        function openAppointmentModal(year, month, day) {
            currentApptId = null;
            document.getElementById('apptPatient').value = '';
            document.getElementById('apptTime').value = '';
            document.getElementById('apptValue').value = '';
            
            if (year !== undefined) {
                const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                document.getElementById('apptDate').value = dateStr;
            } else {
                document.getElementById('apptDate').value = new Date().toISOString().split('T')[0];
            }
            
            document.getElementById('appointmentModal').classList.add('active');
        }

        function editAppointment(id) {
            const appt = appointments.find(a => a.id === id);
            currentApptId = id;
            
            document.getElementById('apptPatient').value = appt.patientId;
            document.getElementById('apptDate').value = appt.date;
            document.getElementById('apptTime').value = appt.time;
            document.getElementById('apptType').value = appt.type;
            document.getElementById('apptValue').value = appt.value;
            
            document.getElementById('appointmentModal').classList.add('active');
        }

        function saveAppointment() {
            const patientId = document.getElementById('apptPatient').value;
            if (!patientId) {
                alert('Selecione um paciente!');
                return;
            }
            
            const patient = patients.find(p => p.id === patientId);
            const data = {
                id: currentApptId || Date.now().toString(),
                patientId: patientId,
                date: document.getElementById('apptDate').value,
                time: document.getElementById('apptTime').value,
                type: document.getElementById('apptType').value,
                value: document.getElementById('apptValue').value || patient.defaultValue || 0,
                paid: currentApptId ? appointments.find(a => a.id === currentApptId).paid : false,
                cancelled: currentApptId ? appointments.find(a => a.id === currentApptId).cancelled : false
            };
            
            if (currentApptId) {
                const idx = appointments.findIndex(a => a.id === currentApptId);
                appointments[idx] = data;
            } else {
                appointments.push(data);
            }
            
            localStorage.setItem('asm_appointments', JSON.stringify(appointments));
            closeModal('appointmentModal');
            renderCalendarspan>
                        <span class="cred-value" id="resName"></span>
                    </div>
                    <div class="cred-item">
                        <span class="cred-label">Usu√°rio:</span>
                        <span class="cred-value" id="resUser"></span>
                    </div>
                    <div class="cred-item">
                        <span class="cred-label">Senha:</span>
                        <span class="cred-value" id="resPass"></span>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn-generate" onclick="downloadFile()" style="background: #264653;">
                        üì• BAIXAR ARQUIVO HTML PRONTO
                    </button>
                </div>
                
                <div class="instructions">
                    <h4>üì§ Como enviar para o profissional:</h4>
                    <ol>
                        <li>Clique no bot√£o acima para baixar o arquivo</li>
                        <li>O arquivo ter√° o nome: <strong>ASM_[nome_do_profissional].html</strong></li>
                        <li>Envie este arquivo via WhatsApp, e-mail ou Telegram</li>
                        <li>O profissional abre no navegador e usa as credenciais acima</li>
                        <li>Pronto! Ele ter√° acesso apenas aos dados dele</li>
                    </ol>
                </div>
                
                <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #28a745;">
                    <strong>üí° Dica:</strong> Guarde as credenciais em um arquivo separado. O profissional pode trocar a senha depois nas configura√ß√µes do sistema.
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p><strong>ASM Gest√£o Cl√≠nica</strong> - Sistema Exclusivo por Dra. Andresa Augusto</p>
            <p>¬© 2024 - Todos os direitos reservados</p>
        </div>
    </div>

    <script>
        let generatedCode = '';
        
        function generateCode() {
            const name = document.getElementById('profName').value.trim();
            const user = document.getElementById('profUser').value.trim().toLowerCase();
            const pass = document.getElementById('profPass').value.trim();
            
            if (!name || !user || !pass) {
                alert('Preencha todos os campos!');
                return;
            }
            
            if (pass.length < 6) {
                alert('A senha deve ter no m√≠nimo 6 caracteres!');
                return;
            }
            
            // Gerar o c√≥digo completo do sistema com login √∫nico embutido
            generatedCode = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASM Gest√£o Cl√≠nica - ${name}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: #f0f2f5;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #264653 0%, #2a9d8f 100%);
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        
        .login-box h1 {
            color: #264653;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .login-box h2 {
            color: #666;
            font-size: 18px;
            margin-bottom: 30px;
            font-weight: normal;
        }
        
        .login-box .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .login-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .login-box input:focus {
            outline: none;
            border-color: #2a9d8f;
        }
        
        .login-btn {
            width: 100%;
            padding: 14px;
            background: #2a9d8f;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .login-btn:hover {
            background: #21867a;
        }
        
        .login-error {
            color: #e76f51;
            margin-top: 15px;
            display: none;
        }
        
        .header {
            background: #264653;
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .header p { font-size: 14px; opacity: 0.9; }
        
        .user-bar {
            background: #1a3a47;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        
        .user-bar button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background: #2a9d8f;
            flex-wrap: wrap;
        }
        
        .nav button {
            padding: 10px 20px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .nav button:hover, .nav button.active {
            background: white;
            color: #264653;
        }
        
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .section {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section.active { display: block; }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        .btn-primary { background: #2a9d8f; color: white; }
        .btn-success { background: #52b788; color: white; }
        .btn-danger { background: #e76f51; color: white; }
        .btn-whatsapp { background: #25d366; color: white; }
        .btn-warning { background: #f4a261; color: white; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .card:hover {
            border-color: #2a9d8f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 20px;
        }
        
        .calendar-header {
            text-align: center;
            font-weight: bold;
            padding: 10px;
            background: #264653;
            color: white;
        }
        
        .calendar-day {
            background: #f8f9fa;
            min-height: 100px;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .calendar-day:hover { background: #e9ecef; }
        
        .appointment {
            background: #2a9d8f;
            color: white;
            padding: 5px;
            margin: 2px 0;
            border-radius: 3px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .appointment.cancelled {
            background: #adb5bd;
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        .appointment-actions {
            display: flex;
            gap: 3px;
        }
        
        .appointment-actions button {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-btn {
            font-size: 24px;
            cursor: pointer;
            background: none;
            border: none;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th { background: #f8f9fa; font-weight: bold; }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            color: white;
        }
        
        .summary-card.green { background: #52b788; }
        .summary-card.red { background: #e76f51; }
        .summary-card.blue { background: #264653; }
        
        .summary-card h3 { font-size: 32px; margin-bottom: 5px; }
        .summary-card p { font-size: 14px; opacity: 0.9; }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }
        
        .tab.active {
            color: #2a9d8f;
            border-bottom: 2px solid #2a9d8f;
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .report-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: monospace;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .settings-box {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #264653;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            background: #264653;
            color: white;
            margin-top: 40px;
            font-size: 12px;
        }
        
        .footer p { margin: 5px 0; opacity: 0.8; }
    </style>
</head>
<body>
    <!-- TELA DE LOGIN -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1>üè• ASM Gest√£o Cl√≠nica</h1>
            <h2>Acesso Exclusivo<br><strong>${name}</strong></h2>
            
            <div class="form-group">
                <label>Usu√°rio</label>
                <input type="text" id="loginUser" placeholder="Digite seu usu√°rio">
            </div>
            
            <div class="form-group">
                <label>Senha</label>
                <input type="password" id="loginPass" placeholder="Digite sua senha">
            </div>
            
            <button class="login-btn" onclick="doLogin()">Entrar</button>
            <div id="loginError" class="login-error">Usu√°rio ou senha incorretos!</div>
        </div>
    </div>

    <!-- SISTEMA PRINCIPAL -->
    <div id="mainSystem" style="display: none;">
        <div class="header">
            <h1>üè• ASM Gest√£o Cl√≠nica</h1>
            <p id="headerSubtitle">Sistema de Gest√£o para Fisioterapeutas</p>
        </div>
        
        <div class="user-bar">
            <div>üë§ <span id="currentUserName">${name}</span></div>
            <div>
                <button onclick="logout()">üö™ Sair</button>
            </div>
        </div>
        
        <div class="nav">
            <button class="active" onclick="showSection('agenda')">üìÖ Agenda</button>
            <button onclick="showSection('pacientes')">üë• Pacientes</button>
            <button onclick="showSection('financeiro')">üí∞ Financeiro</button>
            <button onclick="showSection('fluxo')">üìä Fluxo de Caixa</button>
            <button onclick="showSection('relatorios')">üìà Relat√≥rios</button>
            <button onclick="showSection('configuracoes')">‚öôÔ∏è Configura√ß√µes</button>
        </div>
        
        <div class="container">
            <!-- CONFIGURA√á√ïES -->
            <div id="configuracoes" class="section">
                <h2>‚öôÔ∏è Configura√ß√µes do Sistema</h2>
                <p style="margin-bottom: 20px; color: #666;">Configure aqui os dados do profissional que aparecer√£o nos relat√≥rios e mensagens.</p>
                
                <div class="settings-box">
                    <div class="form-group">
                        <label>Nome do Profissional *</label>
                        <input type="text" id="configName" placeholder="Ex: ${name}">
                    </div>
                    
                    <div class="form-group">
                        <label>N√∫mero do CREFITO *</label>
                        <input type="text" id="configCrefito" placeholder="Ex: 123456-F">
                    </div>
                    
                    <div class="form-group">
                        <label>Nome da Cl√≠nica (opcional)</label>
                        <input type="text" id="configClinic" placeholder="Ex: ASM Fisioterapia">
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveConfig()">üíæ Salvar Configura√ß√µes</button>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <strong>‚ÑπÔ∏è Importante:</strong> Estas informa√ß√µes ser√£o usadas automaticamente nas mensagens do WhatsApp e nos relat√≥rios gerados pelo sistema.
                </div>
            </div>
            
            <!-- AGENDA -->
            <div id="agenda" class="section active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Agenda de Atendimentos</h2>
                    <button class="btn btn-primary" onclick="openAppointmentModal()">+ Novo Agendamento</button>
                </div>
                
                <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="changeMonth(-1)">‚Üê Anterior</button>
                    <h3 id="currentMonth"></h3>
                    <button class="btn btn-primary" onclick="changeMonth(1)">Pr√≥ximo ‚Üí</button>
                </div>
                
                <div class="calendar" id="calendar"></div>
            </div>
            
            <!-- PACIENTES -->
            <div id="pacientes" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Cadastro de Pacientes</h2>
                    <button class="btn btn-primary" onclick="openPatientModal()">+ Novo Paciente</button>
                </div>
                
                <input type="text" style="width: 100%; padding: 10px; margin-bottom: 20px;" placeholder="Buscar paciente..." oninput="searchPatients(this.value)">
                
                <div class="grid" id="patientsList"></div>
            </div>
            
            <!-- FINANCEIRO -->
            <div id="financeiro" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Controle Financeiro</h2>
                    <button class="btn btn-success" onclick="exportToExcel()">üìä Exportar Excel</button>
                </div>
                
                <div class="summary-cards">
                    <div class="summary-card green">
                        <h3 id="totalReceived">R$ 0,00</h3>
                        <p>Total Recebido</p>
                    </div>
                    <div class="summary-card red">
                        <h3 id="totalPending">R$ 0,00</h3>
                        <p>Total a Receber</p>
                    </div>
                    <div class="summary-card blue">
                        <h3 id="totalSessions">0</h3>
                        <p>Total de Sess√µes</p>
                    </div>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Paciente</th>
                            <th>Data</th>
                            <th>Servi√ßo</th>
                            <th>Valor</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="financialTable"></tbody>
                </table>
            </div>
            
            <!-- FLUXO DE CAIXA -->
            <div id="fluxo" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Fluxo de Caixa</h2>
                    <button class="btn btn-primary" onclick="openExpenseModal()">+ Nova Despesa</button>
                </div>
                
                <div class="form-group">
                    <label>M√™s/Ano</label>
                    <input type="month" id="cashFlowMonth" onchange="renderCashFlow()">
                </div>
                
                <div class="summary-cards">
                    <div class="summary-card green">
                        <h3 id="cfEntries">R$ 0,00</h3>
                        <p>Entradas</p>
                    </div>
                    <div class="summary-card red">
                        <h3 id="cfExits">R$ 0,00</h3>
                        <p>Sa√≠das</p>
                    </div>
                    <div class="summary-card blue">
                        <h3 id="cfBalance">R$ 0,00</h3>
                        <p>Saldo</p>
                    </div>
                </div>
                
                <div class="tabs">
                    <button class="tab active" onclick="showCashFlowTab('entries')">Entradas</button>
                    <button class="tab" onclick="showCashFlowTab('exits')">Despesas</button>
                </div>
                
                <div id="cfEntriesTab" class="tab-content active">
                    <table>
                        <thead>
                            <tr><th>Data</th><th>Paciente</th><th>Servi√ßo</th><th>Valor</th></tr>
                        </thead>
                        <tbody id="entriesTable"></tbody>
                    </table>
                </div>
                
                <div id="cfExitsTab" class="tab-content">
                    <table>
                        <thead>
                            <tr><th>Data</th><th>Descri√ß√£o</th><th>Categoria</th><th>Valor</th><th>A√ß√µes</th></tr>
                        </thead>
                        <tbody id="exitsTable"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- RELAT√ìRIOS -->
            <div id="relatorios" class="section">
                <h2>Relat√≥rios de Gest√£o</h2>
                
                <div class="form-group">
                    <label>M√™s/Ano</label>
                    <input type="month" id="reportMonth" onchange="renderReports()">
                </div>
                
                <div class="summary-cards">
                    <div class="summary-card blue">
                        <h3 id="reportSessions">0</h3>
                        <p>Atendimentos</p>
                    </div>
                    <div class="summary-card green">
                        <h3 id="reportRevenue">R$ 0,00</h3>
                        <p>Faturamento</p>
                    </div>
                </div>
                
                <h3 style="margin-top: 30px;">Pacientes Atendidos</h3>
                <table>
                    <thead>
                        <tr><th>Paciente</th><th>Sess√µes</th><th>Total</th></tr>
                    </thead>
                    <tbody id="reportTable"></tbody>
                </table>
            </div>
        </div>
        
        <!-- MODAIS (simplificados para o exemplo) -->
        <div class="modal" id="appointmentModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Agendamento</h3>
                    <button class="close-btn" onclick="closeModal('appointmentModal')">&times;</button>
                </div>
                <div class="form-group">
                    <label>Paciente *</label>
                    <select id="apptPatient"></select>
                </div>
                <div class="form-group">
                    <label>Data *</label>
                    <input type="date" id="apptDate">
                </div>
                <div class="form-group">
                    <label>Hor√°rio *</label>
                    <input type="time" id="apptTime">
                </div>
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="apptType">
                        <option value="normal">Normal</option>
                        <option value="laser">Com Laser</option>
                        <option value="avaliacao">Avalia√ß√£o</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Valor (R$)</label>
                    <input type="number" id="apptValue" step="0.01">
                </div>
                <button class="btn btn-primary" onclick="saveAppointment()">Salvar</button>
            </div>
        </div>
        
        <div class="modal" id="patientModal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h3 id="patientModalTitle">Novo Paciente</h3>
                    <button class="close-btn" onclick="closeModal('patientModal')">&times;</button>
                </div>
                <div class="tabs">
                    <button class="tab active" onclick="showPatientTab('info')">Informa√ß√µes</button>
                    <button class="tab" onclick="showPatientTab('financeiro')">Financeiro</button>
                    <button class="tab" onclick="showPatientTab('evolucao')">Evolu√ß√£o</button>
                </div>
                <div id="tabInfo" class="tab-content active">
                    <input type="hidden" id="patientId">
                    <div class="form-group">
                        <label>Nome Completo *</label>
                        <input type="text" id="patientName">
                    </div>
                    <div class="form-group">
                        <label>Telefone *</label>
                        <input type="tel" id="patientPhone" placeholder="(00) 00000-0000">
                    </div>
                    <div class="form-group">
                        <label>E-mail</label>
                        <input type="email" id="patientEmail">
                    </div>
                    <div class="form-group">
                        <label>Valor Padr√£o (R$)</label>
                        <input type="number" id="patientValue" step="0.01">
                    </div>
                </div>
                <div id="tabFinanceiro" class="tab-content">
                    <div class="summary-cards">
                        <div class="summary-card green">
                            <h3 id="patientPaid">R$ 0,00</h3>
                            <p>Pago</p>
                        </div>
                        <div class="summary-card red">
                            <h3 id="patientPending">R$ 0,00</h3>
                            <p>Pendente</p>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr><th>Data</th><th>Servi√ßo</th><th>Valor</th><th>Status</th></tr>
                        </thead>
                        <tbody id="patientFinanceTable"></tbody>
                    </table>
                </div>
                <div id="tabEvolucao" class="tab-content">
                    <div class="form-group">
                        <label>Nova Evolu√ß√£o</label>
                        <textarea id="newEvolution" rows="4" placeholder="Descreva a evolu√ß√£o..."></textarea>
                        <button class="btn btn-primary" onclick="addEvolution()" style="margin-top: 10px;">Salvar Evolu√ß√£o</button>
                    </div>
                    <div id="evolutionsList"></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button class="btn btn-danger" id="btnDeletePatient" onclick="deletePatient()">Excluir</button>
                    <button class="btn btn-primary" onclick="savePatient()">Salvar Paciente</button>
                </div>
            </div>
        </div>
        
        <div class="modal" id="expenseModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Nova Despesa</h3>
                    <button class="close-btn" onclick="closeModal('expenseModal')">&times;</button>
                </div>
                <div class="form-group">
                    <label>Data *</label>
                    <input type="date" id="expenseDate">
                </div>
                <div class="form-group">
                    <label>Descri√ß√£o *</label>
                    <input type="text" id="expenseDesc" placeholder="Ex: Aluguel, Material...">
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="expenseCategory">
                        <option value="material">Material/Equipamento</option>
                        <option value="aluguel">Aluguel</option>
                        <option value="servicos">Servi√ßos</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Valor (R$) *</label>
                    <input type="number" id="expenseValue" step="0.01">
                </div>
                <button class="btn btn-primary" onclick="saveExpense()">Salvar Despesa</button>
            </div>
        </div>

        <div class="footer">
            <p><strong>ASM Gest√£o Cl√≠nica</strong></p>
            <p>¬© 2024 Dra. Andresa Augusto - Todos os direitos reservados</p>
            <p>Proibida a reprodu√ß√£o total ou parcial sem autoriza√ß√£o expressa</p>
            <p>Desenvolvido exclusivamente para uso profissional autorizado</p>
        </div>
    </div>

    <script>
        // CREDENCIAIS FIXAS (embbeded)
        const VALID_USER = '${user}';
        const VALID_PASS = '${pass}';
        const USER_NAME = '${name}';
        
        // DADOS DO USU√ÅRIO
        let config = JSON.parse(localStorage.getItem('asm_config')) || {
            professionalName: USER_NAME,
            crefito: '',
            clinicName: 'ASM Fisioterapia'
        };
        
        let patients = JSON.parse(localStorage.getItem('asm_patients')) || [];
        let appointments = JSON.parse(localStorage.getItem('asm_appointments')) || [];
        let evolutions = JSON.parse(localStorage.getItem('asm_evolutions')) || [];
        let expenses = JSON.parse(localStorage.getItem('asm_expenses')) || [];
        
        let currentDate = new Date();
        let currentPatientId = null;
        let currentApptId = null;

        // LOGIN
        function doLogin() {
            const u = document.getElementById('loginUser').value.trim().toLowerCase();
            const p = document.getElementById('loginPass').value;
            
            if (u === VALID_USER && p === VALID_PASS) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainSystem').style.display = 'block';
                initializeApp();
            } else {
                document.getElementById('loginError').style.display = 'block';
                setTimeout(() => document.getElementById('loginError').style.display = 'none', 3000);
            }
        }
        
        function logout() {
            location.reload();
        }
        
        function initializeApp() {
            loadConfig();
            renderCalendar();
            renderPatients();
            updateFinancialSummary();
            loadPatientSelect();
            
            const today = new Date().toISOString().slice(0, 7);
            document.getElementById('cashFlowMonth').value = today;
            document.getElementById('reportMonth').value = today;
        }

        function loadConfig() {
            document.getElementById('configName').value = config.professionalName;
            document.getElementById('configCrefito').value = config.crefito;
            document.getElementById('configClinic').value = config.clinicName;
            updateHeader();
        }
        
        function saveConfig() {
            config.professionalName = document.getElementById('configName').value.trim();
            config.crefito = document.getElementById('configCrefito').value.trim();
            config.clinicName = document.getElementById('configClinic').value.trim() || 'ASM Fisioterapia';
            
            if (!config.professionalName || !config.crefito) {
                alert('Preencha o nome do profissional e o CREFITO!');
                return;
            }
            
            localStorage.setItem('asm_config', JSON.stringify(config));
            updateHeader();
            alert('Configura√ß√µes salvas com sucesso!');
        }
        
        function updateHeader() {
            const subtitle = document.getElementById('headerSubtitle');
            if (config.professionalName) {
                subtitle.textContent = config.professionalName + ' - CREFITO ' + config.crefito;
            } else {
                subtitle.textContent = 'Configure seus dados em "Configura√ß√µes"';
            }
        }
        
        function getProfessionalSignature() {
            const name = config.professionalName || 'Profissional';
            const crefito = config.crefito ? 'CREFITO ' + config.crefito : '';
            const clinic = config.clinicName || 'ASM Fisioterapia';
            return { name, crefito, clinic };
        }

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            
            document.getElementById(section).classList.add('active');
            event.target.classList.add('active');
            
            if (section === 'financeiro') renderFinancialTable();
            if (section === 'fluxo') renderCashFlow();
            if (section === 'relatorios') renderReports();
        }

        // CALEND√ÅRIO
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonth').textContent = 
                new Date(year, month).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';
            
            const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            days.forEach(day => {
                const div = document.createElement('div');
                div.className = 'calendar-header';
                div.textContent = day;
                calendar.appendChild(div);
            });
            
            for (let i = 0; i < firstDay; i++) {
                calendar.appendChild(document.createElement('div'));
            }
            
            const today = new Date();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const div = document.createElement('div');
                div.className = 'calendar-day';
                div.innerHTML = '<strong>' + day + '</strong>';
                
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    div.style.background = '#2a9d8f';
                    div.style.color = 'white';
                }
                
                const dayAppointments = appointments.filter(a => {
                    const parts = a.date.split('-');
                    const y = parseInt(parts[0]);
                    const m = parseInt(parts[1]);
                    const d = parseInt(parts[2]);
                    return y === year && (m - 1) === month && d === day;
                });
                
                dayAppointments.forEach(appt => {
                    const patient = patients.find(p => p.id === appt.patientId);
                    const apptDiv = document.createElement('div');
                    apptDiv.className = 'appointment' + (appt.cancelled ? ' cancelled' : '');
                    apptDiv.innerHTML = '<span>' + appt.time + ' ' + (patient ? patient.name.split(' ')[0] : '') + '</span>';
                    
                    const actions = document.createElement('div');
                    actions.className = 'appointment-actions';
                    
                    const editBtn = document.createElement('button');
                    editBtn.textContent = '‚úé';
                    editBtn.onclick = function(e) {
                        e.stopPropagation();
                        editAppointment(appt.id);
                    };
                    
                    const cancelBtn = document.createElement('button');
                    cancelBtn.textContent = appt.cancelled ? '‚Ü©' : '‚úï';
                    cancelBtn.onclick = function(e) {
                        e.stopPropagation();
                        toggleCancelAppointmentDirect(appt.id);
                    };
                    
                    actions.appendChild(editBtn);
                    actions.appendChild(cancelBtn);
                    apptDiv.appendChild(actions);
                    
                    div.appendChild(apptDiv);
                });
                
                div.onclick = function() {
                    openAppointmentModal(year, month, day);
                };
                calendar.appendChild(div);
            }
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }

        // PACIENTES
        function renderPatients() {
            const list = document.getElementById('patientsList');
            list.innerHTML = '';
            
            patients.forEach(p => {
                const patientAppts = appointments.filter(a => a.patientId === p.id && !a.cancelled);
                const pending = patientAppts.filter(a => !a.paid).length;
                
                const card = document.createElement('div');
                card.className = 'card';
                let html = '<h3>' + p.name + '</h3>';
                html += '<p>üì± ' + p.phone + '</p>';
                html += '<p>üí∞ R$ ' + parseFloat(p.defaultValue || 0).toFixed(2) + '</p>';
                if (pending > 0) {
                    html += '<p style="color: #e76f51;">‚ö†Ô∏è ' + pending + ' pendente(s)</p>';
                }
                card.innerHTML = html;
                card.onclick = function() {
                    openPatientModal(p.id);
                };
                list.appendChild(card);
            });
        }

        function searchPatients(term) {
            const cards = document.querySelectorAll('#patientsList .card');
            cards.forEach(card => {
                const name = card.querySelector('h3').textContent.toLowerCase();
                card.style.display = name.includes(term.toLowerCase()) ? 'block' : 'none';
            });
        }

        function openPatientModal(patientId) {
            currentPatientId = patientId;
            const modal = document.getElementById('patientModal');
            
            document.getElementById('patientId').value = '';
            document.getElementById('patientName').value = '';
            document.getElementById('patientPhone').value = '';
            document.getElementById('patientEmail').value = '';
            document.getElementById('patientValue').value = '';
            
            showPatientTab('info');
            
            if (patientId) {
                const p = patients.find(x => x.id === patientId);
                document.getElementById('patientModalTitle').textContent = 'Editar Paciente';
                document.getElementById('patientId').value = p.id;
                document.getElementById('patientName').value = p.name;
                document.getElementById('patientPhone').value = p.phone;
                document.getElementById('patientEmail').value = p.email || '';
                document.getElementById('patientValue').value = p.defaultValue || '';
                document.getElementById('btnDeletePatient').style.display = 'block';
                
                renderPatientFinance();
                renderEvolutions();
            } else {
                document.getElementById('patientModalTitle').textContent = 'Novo Paciente';
                document.getElementById('btnDeletePatient').style.display = 'none';
            }
            
            modal.classList.add('active');
        }

        function savePatient() {
            const id = document.getElementById('patientId').value;
            const data = {
                id: id || Date.now().toString(),
                name: document.getElementById('patientName').value,
                phone: document.getElementById('patientPhone').value,
                email: document.getElementById('patientEmail').value,
                defaultValue: document.getElementById('patientValue').value
            };
            
            if (!data.name || !data.phone) {
                alert('Preencha nome e telefone!');
                return;
            }
            
            if (id) {
                const idx = patients.findIndex(p => p.id === id);
                patients[idx] = data;
            } else {
                patients.push(data);
            }
            
            localStorage.setItem('asm_patients', JSON.stringify(patients));
            closeModal('patientModal');
            renderPatients();
            loadPatientSelect();
        }

        function deletePatient() {
            if (!confirm('Excluir paciente e todos os dados?')) return;
            
            patients = patients.filter(p => p.id !== currentPatientId);
            appointments = appointments.filter(a => a.patientId !== currentPatientId);
            evolutions = evolutions.filter(e => e.patientId !== currentPatientId);
            
            localStorage.setItem('asm_patients', JSON.stringify(patients));
            localStorage.setItem('asm_appointments', JSON.stringify(appointments));
            localStorage.setItem('asm_evolutions', JSON.stringify(evolutions));
            
            closeModal('patientModal');
            renderPatients();
            renderCalendar();
            updateFinancialSummary();
        }

        function showPatientTab(tab) {
            document.querySelectorAll('#patientModal .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#patientModal .tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            
            if (tab === 'financeiro') renderPatientFinance();
            if (tab === 'evolucao') renderEvolutions();
        }

        // AGENDAMENTOS
        function openAppointmentModal(year, month, day) {
            currentApptId = null;
            document.getElementById('apptPatient').value = '';
            document.getElementById('apptTime').value = '';
            document.getElementById('apptValue').value = '';
            
            if (year !== undefined) {
                const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                document.getElementById('apptDate').value = dateStr;
            } else {
                document.getElementById('apptDate').value = new Date().toISOString().split('T')[0];
            }
            
            document.getElementById('appointmentModal').classList.add('active');
        }

        function editAppointment(id) {
            const appt = appointments.find(a => a.id === id);
            currentApptId = id;
            
            document.getElementById('apptPatient').value = appt.patientId;
            document.getElementById('apptDate').value = appt.date;
            document.getElementById('apptTime').value = appt.time;
            document.getElementById('apptType').value = appt.type;
            document.getElementById('apptValue').value = appt.value;
            
            document.getElementById('appointmentModal').classList.add('active');
        }

        function saveAppointment() {
            const patientId = document.getElementById('apptPatient').value;
            if (!patientId) {
                alert('Selecione um paciente!');
                return;
            }
            
            const patient = patients.find(p => p.id === patientId);
            const data = {
                id: currentApptId || Date.now().toString(),
                patientId: patientId,
                date: document.getElementById('apptDate').value,
                time: document.getElementById('apptTime').value,
                type: document.getElementById('apptType').value,
                value: document.getElementById('apptValue').value || patient.defaultValue || 0,
                paid: currentApptId ? appointments.find(a => a.id === currentApptId).paid : false,
                cancelled: currentApptId ? appointments.find(a => a.id === currentApptId).cancelled : false
            };
            
            if (currentApptId) {
                const idx = appointments.findIndex(a => a.id === currentApptId);
                appointments[idx] = data;
            } else {
                appointments.push(data);
            }
            
            localStorage.setItem('asm_appointments', JSON.stringify(appointments));
            closeModal('appointmentModal');
            renderCalendar();
            updateFinancialSummary();
        }

        function toggleCancelAppointmentDirect(id) {
            const appt = appointments.find(a => a.id === id);
            appt.cancelled = !appt.cancelled;
            localStorage.setItem('asm_appointments', JSON.stringify(appointments));
            renderCalendar();
            updateFinancialSummary();
        }

        // FINANCEIRO
        function renderFinancialTable() {
            const tbody = document.getElementById('financialTable');
            tbody.innerHTML = '';
            
            const sorted = appointments.filter(a => !a.cancelled).slice().sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sorted.forEach(appt => {
                const patient = patients.find(p => p.id === appt.patientId);
                const row = document.createElement('tr');
                
                let html = '<td>' + (patient ? patient.name : '-') + '</td>';
                html += '<td>' + formatDate(appt.date) + '</td>';
                html += '<td>' + (appt.type === 'laser' ? 'Laser' : 'Normal') + '</td>';
                html += '<td>R$ ' + parseFloat(appt.value || 0).toFixed(2) + '</td>';
                html += '<td>' + (appt.paid ? '‚úÖ Pago' : '‚è≥ Pendente') + '</td>';
                html += '<td><button class="btn btn-primary" onclick="togglePayment(\'' + appt.id + '\')">' + (appt.paid ? 'Desmarcar' : 'Pagar') + '</button></td>';
                
                row.innerHTML = html;
                tbody.appendChild(row);
            });
        }

        function renderPatientFinance() {
            const patientAppts = appointments.filter(a => a.patientId === currentPatientId && !a.cancelled);
            const paid = patientAppts.filter(a => a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
            const pending = patientAppts.filter(a => !a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
            
            document.getElementById('patientPaid').textContent = 'R$ ' + paid.toFixed(2);
            document.getElementById('patientPending').textContent = 'R$ ' + pending.toFixed(2);
            
            const tbody = document.getElementById('patientFinanceTable');
            tbody.innerHTML = '';
            
            patientAppts.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            patientAppts.forEach(appt => {
                const row = document.createElement('tr');
                let html = '<td>' + formatDate(appt.date) + '</td>';
                html += '<td>' + appt.type + '</td>';
                html += '<td>R$ ' + parseFloat(appt.value || 0).toFixed(2) + '</td>';
                html += '<td>' + (appt.paid ? 'Pago' : 'Pendente') + '</td>';
                row.innerHTML = html;
                tbody.appendChild(row);
            });
        }

        function updateFinancialSummary() {
            const activeAppts = appointments.filter(a => !a.cancelled);
            const received = activeAppts.filter(a => a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
            const pending = activeAppts.filter(a => !a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
            
            document.getElementById('totalReceived').textContent = 'R$ ' + received.toFixed(2);
            document.getElementById('totalPending').textContent = 'R$ ' + pending.toFixed(2);
            document.getElementById('totalSessions').textContent = activeAppts.length;
        }

        function togglePayment(id) {
            const appt = appointments.find(a => a.id === id);
            appt.paid = !appt.paid;
            localStorage.setItem('asm_appointments', JSON.stringify(appointments));
            
            renderFinancialTable();
            updateFinancialSummary();
            renderCalendar();
            if (currentPatientId) renderPatientFinance();
        }

        // EVOLU√á√ïES
        function renderEvolutions() {
            const list = document.getElementById('evolutionsList');
            list.innerHTML = '';
            
            const patientEvos = evolutions.filter(e => e.patientId === currentPatientId)
                .sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time));
            
            patientEvos.forEach(evo => {
                const div = document.createElement('div');
                div.style.cssText = 'background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #2a9d8f;';
                div.innerHTML = '<small style="color: #666;">' + formatDate(evo.date) + ' √†s ' + evo.time + '</small><p style="margin-top: 5px;">' + evo.text + '</p>';
                list.appendChild(div);
            });
        }

        function addEvolution() {
            const text = document.getElementById('newEvolution').value;
            if (!text.trim()) return;
            
            const now = new Date();
            const evo = {
                id: Date.now().toString(),
                patientId: currentPatientId,
                date: now.toISOString().split('T')[0],
                time: now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                text: text
            };
            
            evolutions.push(evo);
            localStorage.setItem('asm_evolutions', JSON.stringify(evolutions));
            
            document.getElementById('newEvolution').value = '';
            renderEvolutions();
        }

        // FLUXO DE CAIXA
        function openExpenseModal() {
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('expenseModal').classList.add('active');
        }

        function saveExpense() {
            const data = {
                id: Date.now().toString(),
                date: document.getElementById('expenseDate').value,
                description: document.getElementById('expenseDesc').value,
                category: document.getElementById('expenseCategory').value,
                value: parseFloat(document.getElementById('expenseValue').value)
            };
            
            if (!data.date || !data.description || !data.value) {
                alert('Preencha todos os campos!');
                return;
            }
            
            expenses.push(data);
            localStorage.setItem('asm_expenses', JSON.stringify(expenses));
            
            closeModal('expenseModal');
            document.getElementById('expenseDesc').value = '';
            document.getElementById('expenseValue').value = '';
            renderCashFlow();
        }

        function showCashFlowTab(tab) {
            document.querySelectorAll('#fluxo .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#fluxo .tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('cf' + tab.charAt(0).toUpperCase() + tab.slice(1) + 'Tab').classList.add('active');
        }

        function renderCashFlow() {
            const month = document.getElementById('cashFlowMonth').value;
            if (!month) return;
            
            const parts = month.split('-');
            const year = parseInt(parts[0]);
            const mon = parseInt(parts[1]);
            
            const entries = appointments.filter(a => {
                if (!a.paid || a.cancelled) return false;
                const ap = a.date.split('-');
                return parseInt(ap[0]) === year && parseInt(ap[1]) === mon;
            });
            
            const exits = expenses.filter(e => {
                const ep = e.date.split('-');
                return parseInt(ep[0]) === year && parseInt(ep[1]) === mon;
            });
            
            const totalEntries = entries.reduce((s, a) => s + parseFloat(a.value || 0), 0);
            const totalExits = exits.reduce((s, e) => s + parseFloat(e.value || 0), 0);
            
            document.getElementById('cfEntries').textContent = 'R$ ' + totalEntries.toFixed(2);
            document.getElementById('cfExits').textContent = 'R$ ' + totalExits.toFixed(2);
            document.getElementById('cfBalance').textContent = 'R$ ' + (totalEntries - totalExits).toFixed(2);
            
            const entriesBody = document.getElementById('entriesTable');
            entriesBody.innerHTML = '';
            entries.forEach(a => {
                const p = patients.find(x => x.id === a.patientId);
                const row = document.createElement('tr');
                row.innerHTML = '<td>' + formatDate(a.date) + '</td><td>' + (p ? p.name : '-') + '</td><td>' + a.type + '</td><td>R$ ' + parseFloat(a.value || 0).toFixed(2) + '</td>';
                entriesBody.appendChild(row);
            });
            
            const exitsBody = document.getElementById('exitsTable');
            exitsBody.innerHTML = '';
            exits.forEach(e => {
                const row = document.createElement('tr');
                row.innerHTML = '<td>' + formatDate(e.date) + '</td><td>' + e.description + '</td><td>' + e.category + '</td><td>R$ ' + parseFloat(e.value).toFixed(2) + '</td><td><button class="btn btn-danger" onclick="deleteExpense(\'' + e.id + '\')">Excluir</button></td>';
                exitsBody.appendChild(row);
            });
        }

        function deleteExpense(id) {
            if (!confirm('Excluir esta despesa?')) return;
            expenses = expenses.filter(e => e.id !== id);
            localStorage.setItem('asm_expenses', JSON.stringify(expenses));
            renderCashFlow();
        }

        // RELAT√ìRIOS GERAIS
        function renderReports() {
            const month = document.getElementById('reportMonth').value;
            if (!month) return;
            
            const parts = month.split('-');
            const year = parseInt(parts[0]);
            const mon = parseInt(parts[1]);
            
            const monthAppts = appointments.filter(a => {
                if (a.cancelled) return false;
                const ap = a.date.split('-');
                return parseInt(ap[0]) === year && parseInt(ap[1]) === mon;
            });
            
            const revenue = monthAppts.filter(a => a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
            
            document.getElementById('reportSessions').textContent = monthAppts.length;
            document.getElementById('reportRevenue').textContent = 'R$ ' + revenue.toFixed(2);
            
            const stats = {};
            monthAppts.forEach(a => {
                if (!stats[a.patientId]) stats[a.patientId] = { count: 0, total: 0 };
                stats[a.patientId].count++;
                if (a.paid) stats[a.patientId].total += parseFloat(a.value || 0);
            });
            
            const tbody = document.getElementById('reportTable');
            tbody.innerHTML = '';
            
            for (let pid in stats) {
                const p = patients.find(x => x.id === pid);
                const s = stats[pid];
                const row = document.createElement('tr');
                row.innerHTML = '<td>' + (p ? p.name : '-') + '</td><td>' + s.count + '</td><td>R$ ' + s.total.toFixed(2) + '</td>';
                tbody.appendChild(row);
            }
        }

        // EXPORTAR EXCEL
        function exportToExcel() {
            let csv = 'Paciente;Data;Servico;Valor;Status\n';
            
            appointments.filter(a => !a.cancelled).forEach(a => {
                const p = patients.find(x => x.id === a.patientId);
                csv += (p ? p.name : '-') + ';' + formatDate(a.date) + ';' + a.type + ';' + parseFloat(a.value || 0).toFixed(2) + ';' + (a.paid ? 'Pago' : 'Pendente') + '\n';
            });
            
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ASM_Financeiro_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }

        // UTILIT√ÅRIOS
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('-');
            return parts[2] + '/' + parts[1] + '/' + parts[0];
        }

        function loadPatientSelect() {
            const select = document.getElementById('apptPatient');
            select.innerHTML = '<option value="">Selecione...</option>';
            patients.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = p.name;
                select.appendChild(opt);
            });
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        document.querySelectorAll('.modal').forEach(m => {
            m.onclick = function(e) {
                if (e.target === this) this.classList.remove('active');
            };
        });
    </script>
</body>
</html>`;
            
            // Mostrar resultado
            document.getElementById('resName').textContent = name;
            document.getElementById('resUser').textContent = user;
            document.getElementById('resPass').textContent = pass;
            document.getElementById('resultArea').classList.add('show');
            
            // Scroll para o resultado
            document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });
        }
        
        function downloadFile() {
            const name = document.getElementById('profName').value.trim();
            const fileName = 'ASM_' + name.replace(/\s+/g, '_') + '.html';
            
            const blob = new Blob([generatedCode], { type: 'text/html' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
            
            alert('‚úÖ Arquivo gerado com sucesso: ' + fileName + '\n\nEnvie este arquivo para o profissional!');
        }
    </script>
</body>
</html>
